<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ´çŒ«è¡¨æƒ…åŒ…ç”Ÿæˆå™¨</title>
    <style>
        :root {
            --primary-color: #ff9ecd;
            --secondary-color: #ffb7dd;
            --background-color: #fff5f9;
            --card-background: #ffffff;
            --text-color: #855b6d;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* æ·»åŠ çŒ«çˆªèƒŒæ™¯è£…é¥° */
        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 100px;
            height: 100px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50' fill='%23ffcce6' opacity='0.3'%3E%3Cpath d='M25 0C22 0 20 2 20 5C20 8 22 10 25 10C28 10 30 8 30 5C30 2 28 0 25 0zM10 10C7 10 5 12 5 15C5 18 7 20 10 20C13 20 15 18 15 15C15 12 13 10 10 10zM40 10C37 10 35 12 35 15C35 18 37 20 40 20C43 20 45 18 45 15C45 12 43 10 40 10zM15 25C12 25 10 27 10 30C10 33 12 35 15 35C18 35 20 33 20 30C20 27 18 25 15 25zM35 25C32 25 30 27 30 30C30 33 32 35 35 35C38 35 40 33 40 30C40 27 38 25 35 25z'/%3E%3C/svg%3E");
            background-repeat: repeat;
            z-index: -1;
            animation: pawFloat 20s linear infinite;
        }

        body::before {
            top: 0;
            left: 0;
            transform: rotate(45deg);
        }

        body::after {
            bottom: 0;
            right: 0;
            transform: rotate(-135deg);
        }

        @keyframes pawFloat {
            0% {
                transform: translateY(0) rotate(45deg);
            }
            50% {
                transform: translateY(-20px) rotate(45deg);
            }
            100% {
                transform: translateY(0) rotate(45deg);
            }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        .header h1 {
            font-size: 2.2em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(255, 158, 205, 0.3);
        }

        .input-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(255, 158, 205, 0.15);
            margin-bottom: 20px;
            border: 2px solid rgba(255, 158, 205, 0.3);
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            resize: none;
            box-sizing: border-box;
            background-color: #fff;
            color: var(--text-color);
        }

        textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px rgba(255, 158, 205, 0.3);
            outline: none;
        }

        .input-section button {
            width: 100%;
            margin-top: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .input-section button:hover {
            transform: translateY(-3px);
            background-color: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(255, 158, 205, 0.4);
        }

        .input-section button::before {
            content: 'ğŸ¾';
            position: absolute;
            left: -30px;
            opacity: 0;
            transition: all 0.3s;
        }

        .input-section button:hover::before {
            left: 20px;
            opacity: 1;
        }

        .button-group {
            display: flex;
            gap: 15px;
        }

        button.secondary {
            background-color: var(--secondary-color);
        }

        /* æ·»åŠ çŒ«çˆªç‚¹å‡»æ•ˆæœ */
        button:active::after {
            content: 'ğŸ¾';
            position: absolute;
            font-size: 20px;
            animation: pawPrint 0.5s ease-out;
        }

        @keyframes pawPrint {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        #loading {
            position: relative;
        }

        #loading::after {
            content: 'ğŸ±';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            animation: catBounce 0.6s infinite alternate;
        }

        @keyframes catBounce {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        .result-section {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-section h2 {
            color: var(--secondary-color);
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        #response {
            color: #ff5252;
            text-align: center;
            margin: 8px 0;
            font-size: 14px;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.02);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 15px 0;
        }

        .loading::after {
            content: "ç”Ÿæˆä¸­...";
            color: var(--primary-color);
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "ç”Ÿæˆä¸­."; }
            40% { content: "ç”Ÿæˆä¸­.."; }
            60%, 100% { content: "ç”Ÿæˆä¸­..."; }
        }

        .icon {
            font-size: 1.2em;
            line-height: 1;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        #debug {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            display: none;
        }

        /* æ·»åŠ åŠ¨ç”»å…ƒç´ çš„æ ·å¼ */
        .celebration-emoji {
            position: fixed;
            font-size: 20px;
            pointer-events: none;
            z-index: 1000;
            animation: floatAway 1.5s ease-out forwards;
        }

        @keyframes floatAway {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translate(
                    calc(-50% + var(--x-end) * 100px),
                    calc(-50% + var(--y-end) * 100px)
                ) scale(1.2);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ± æŸ´çŒ«è¡¨æƒ…åŒ…ç”Ÿæˆå™¨</h1>
            <p>è¾“å…¥æ–‡å­—æè¿°ï¼ŒAIå¸®ä½ ç”Ÿæˆå¯çˆ±çš„æŸ´çŒ«è¡¨æƒ…åŒ…ï½</p>
            <small style="color: #999;">è¡¨é¢æ˜¯ä¸€åªçŒ«çŒ«ï¼Œå†…å¿ƒæ˜¯ä¸€åªæŸ´çŠ¬</small>
        </div>

        <div class="input-section">
            <div class="input-group">
                <textarea id="input" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç”Ÿæ°”ã€éœ‡æƒŠ..."></textarea>
            </div>
            <button onclick="sendRequest()">
                <span class="icon">âœ¨</span>
                ç”Ÿæˆè¡¨æƒ…åŒ…
            </button>
        </div>

        <div class="loading" id="loading"></div>

        <div class="result-section" id="resultSection">
            <h2>ç”Ÿæˆç»“æœ</h2>
            <div id="response"></div>
            <div class="image-preview" id="imagePreview"></div>
            <div class="button-group" style="margin-top: 15px;">
                <button onclick="saveImage()" class="secondary" id="saveButton" disabled>
                    <span class="icon">ğŸ’¾</span>
                    ä¿å­˜è¡¨æƒ…åŒ…
                </button>
            </div>
        </div>

        <div id="debug"></div>
    </div>

    <script>
        // å½“å‰å›¾ç‰‡URL
        let currentImageUrl = '';

        // Worker URL - éƒ¨ç½²åéœ€è¦ä¿®æ”¹ä¸ºå®é™…çš„Worker URL
        const WORKER_URL = 'https://emoji.otiron.workers.dev/';

        function createCelebrationEffect(centerX, centerY) {
            const emojis = ['ğŸ±', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜»', 'ğŸ˜½'];
            const numEmojis = 12;

            for (let i = 0; i < numEmojis; i++) {
                const emoji = document.createElement('div');
                emoji.className = 'celebration-emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                
                // è®¡ç®—æ•£å¼€æ–¹å‘ï¼ˆå›´ç»•ä¸€ä¸ªåœ†ï¼‰
                const angle = (i / numEmojis) * 2 * Math.PI;
                const xEnd = Math.cos(angle);
                const yEnd = Math.sin(angle);
                
                emoji.style.setProperty('--x-end', xEnd);
                emoji.style.setProperty('--y-end', yEnd);
                emoji.style.left = `${centerX}px`;
                emoji.style.top = `${centerY}px`;
                
                document.body.appendChild(emoji);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                emoji.addEventListener('animationend', () => {
                    document.body.removeChild(emoji);
                });
            }
        }

        async function sendRequest() {
            const inputText = document.getElementById('input').value.trim();
            const responseDiv = document.getElementById('response');
            const imagePreview = document.getElementById('imagePreview');
            const loading = document.getElementById('loading');
            const resultSection = document.getElementById('resultSection');
            const saveButton = document.getElementById('saveButton');
            const debug = document.getElementById('debug');
            
            if (!inputText) {
                alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…æè¿°ï¼');
                return;
            }

            // æ¸…ç©ºä¹‹å‰çš„å“åº”å’Œå›¾ç‰‡
            responseDiv.textContent = '';
            imagePreview.innerHTML = '';
            resultSection.classList.remove('active');
            loading.style.display = 'block';
            saveButton.disabled = true;
            currentImageUrl = '';
            debug.style.display = 'none';
            debug.textContent = '';

            try {
                // å‘é€è¯·æ±‚åˆ°Worker
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: inputText
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // åˆ›å»ºå“åº”æµè¯»å–å™¨
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                // å¤„ç†æµå¼å“åº”
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // å¤„ç†å®Œæ•´çš„äº‹ä»¶
                    const events = buffer.split('\n\n');
                    buffer = events.pop() || '';

                    for (const event of events) {
                        if (!event.trim()) continue;
                        
                        const lines = event.split('\n');
                        const eventType = lines[0].replace('event:', '');
                        const dataStr = lines[1].replace('data:', '');

                        // è°ƒè¯•ä¿¡æ¯
                        debug.textContent += `${event}\n`;

                        try {
                            if (eventType === 'conversation.message.delta') {
                                const data = JSON.parse(dataStr);
                                if (data.type === 'answer' && data.content) {
                                    const content = data.content;
                                    if (content.startsWith('http')) {
                                        resultSection.classList.add('active');
                                        const img = document.createElement('img');
                                        img.src = content;
                                        img.alt = 'ç”Ÿæˆçš„è¡¨æƒ…åŒ…';
                                        img.title = 'ç‚¹å‡»æŸ¥çœ‹åŸå›¾';
                                        img.onclick = () => window.open(content, '_blank');
                                        imagePreview.innerHTML = '';
                                        imagePreview.appendChild(img);
                                        currentImageUrl = content;
                                        saveButton.disabled = false;

                                        // åœ¨å›¾ç‰‡ç”Ÿæˆåæ·»åŠ åº†ç¥åŠ¨ç”»
                                        const rect = imagePreview.getBoundingClientRect();
                                        const centerX = rect.left + rect.width / 2;
                                        const centerY = rect.top + rect.height / 2;
                                        createCelebrationEffect(centerX, centerY);
                                    }
                                }
                            } else if (eventType === 'done') {
                                loading.style.display = 'none';
                            }
                        } catch (e) {
                            console.error('è§£æäº‹ä»¶æ•°æ®å¤±è´¥:', e);
                            debug.textContent += `è§£æé”™è¯¯: ${e.message}\n`;
                        }
                    }
                }

                if (!currentImageUrl) {
                    resultSection.classList.add('active');
                    responseDiv.textContent = 'æœªèƒ½ç”Ÿæˆè¡¨æƒ…åŒ…ï¼Œè¯·é‡è¯•';
                }

            } catch (error) {
                console.error('Error:', error);
                resultSection.classList.add('active');
                responseDiv.textContent = `ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
                loading.style.display = 'none';
            }
        }

        async function saveImage() {
            if (!currentImageUrl) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡ï¼');
                return;
            }

            try {
                const response = await fetch(currentImageUrl);
                const blob = await response.blob();
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `çŒ«çŒ«è¡¨æƒ…åŒ…_${timestamp}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // æ·»åŠ è°ƒè¯•æ¨¡å¼åˆ‡æ¢
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const debug = document.getElementById('debug');
                debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>
